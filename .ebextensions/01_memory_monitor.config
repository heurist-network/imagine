files:
  "/usr/local/bin/memory_monitor.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      MEMORY_THRESHOLD=95
      
      while true; do
        MEMORY_USAGE=$(free | grep Mem | awk '{print $3/$2 * 100.0}' | cut -d. -f1)
        
        if [ $MEMORY_USAGE -gt $MEMORY_THRESHOLD ]; then
          echo "Memory usage is ${MEMORY_USAGE}%, exceeding threshold of ${MEMORY_THRESHOLD}%. Rebooting..."
          /sbin/shutdown -r now
        else
          echo "Memory usage is ${MEMORY_USAGE}%, below threshold of ${MEMORY_THRESHOLD}%."
        fi
        
        sleep 60
      done

  "/etc/systemd/system/memory-monitor.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Memory Monitor Service
      After=network.target
      
      [Service]
      ExecStart=/usr/local/bin/memory_monitor.sh
      Restart=always
      User=root
      
      [Install]
      WantedBy=multi-user.target

commands:
  01_start_memory_monitor:
    command: |
      systemctl daemon-reload
      systemctl enable memory-monitor.service
      systemctl start memory-monitor.service